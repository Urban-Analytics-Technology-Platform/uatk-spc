---
title: "Technical overview"
toc: true
---

SPC is divided into two phases. The data preparation phase relies on scripts that only need to be run once.
The outputs of this phase have been uploaded to a dedicated Azure repository so that they can be used directly during the second phase.
The second phase involves the user choosing a study area and launching a simulation.

The full SPC pipeline comprises the following steps.
- Phase 1: Data preparation steps:
        - The [SPENSER](https://github.com/nismod/microsimulation) model creates a synthetic population with basic demographic information for all of the UK.
        - A [script](https://github.com/alan-turing-institute/uatk-spc/blob/main/scripts/data_prep/raw_to_prepared.R) downloads and prepares data from various public sources that will be used throughout the model.
        - The outputs of SPENSER are enriched using some of these outputs by this [script](https://github.com/alan-turing-institute/uatk-spc/blob/main/scripts/data_prep/SPC_pipelineLAD.R).
        - The resulting outputs are uploaded to a dedicated Azure repository.
- Phase 2: Steps after the user has selected a study area:
        - All the relevant data are downloaded from Azure.
        - Individuals are assigned a single education destination (if relevant) and several potential retail destinations following a local version of [QUANT](https://github.com/maptube/QUANT_RAMP).
        - Individuals are assigned a single workplace destination following the method described [here](https://alan-turing-institute.github.io/uatk-spc/modelling_methods.html#commuting-flows).
        - The population (and an optional lockdown modelling) are gathered into a single protobuffer file that can be visualised by the [SPC explorer](https://alan-turing-institute.github.io/uatk-spc/app/).

We now explain how to run each step. The theoretical principles supporting the modelling are presented [here](https://alan-turing-institute.github.io/uatk-spc/modelling_methods.html).


## Phase 1: Data preparation

![](img/SPC_Schema_full.png)

### SPENSER

The original [SPENSER](https://github.com/nismod/microsimulation) model is made up of 5 different GitHub repositories operating specific parts of the population simulation.
We use this [modified version](https://github.com/alan-turing-institute/spc-hpc-pipeline/tree/30-missing-lads).

The result of SPENSER is two separate datasets and a merging key: one dataset for individuals, accurate at MSOA level and containing the `sex`, `age` and `ethnicity` [fields](https://alan-turing-institute.github.io/uatk-spc/data_sources.html#pop_.csv.gz); and one for households, accurate at OA level and containing the `OA11CD`, `HOUSE_nssec8`, `House_type`, `HOUSE_typeCommunal`, `HOUSE_NRooms`, `HOUSE_centralHeat`, `HOUSE_tenure` and `HOUSE_NCars` [fields](https://alan-turing-institute.github.io/uatk-spc/data_sources.html#pop_.csv.gz) respectively.


### Downloading and preparation of public data from various sources

Instructions to run this step can be found under [Step 1: Curate public data from diverse sources](https://github.com/alan-turing-institute/uatk-spc/tree/main/scripts/data_prep).
The result is a set of data that will be merged with SPENSER in the next step, containing:
- NSSEC8 distributions among the population of England and Wales by age group and sex at MSOA level (`NSSEC8_EW_F_16to24_CLEAN.csv`, etc.) and among the total population of Scotland by age group, sex and ethnicity (`NSSECS_CLEAN.csv`)
- A combined extract from the three latest GB Health Surveys (`HSComplete.csv`)
- An extract from the UK Time Use Survey 2015 (`indivTUS.csv`)
- A file containing a set of coefficients to estimate the average BMI of individuals in England depending on their age, sex and ethnicity (`BMIdMean.csv`) and a file containing coefficients to obtain the equivalent average BMI in Scotland and Wales (`BMIdiff.csv`)
- Coefficients to estimate the hourly salary of an employee in England depending on their home region, sex, part-time/full-time status, age and SOC category (`coefFFT.csv`, etc. & `ageRescaleFFT.csv`, etc.).
- Coefficients to estimate the numbers of hours worked corresponding to the criteria mentioned above (`meanHoursFFT.csv`, etc. and `distribHours.csv`)
- Centroid coordinates of Output areas in GB (`OACentroids.csv`)
In addition, four files are outputed to be used by the second phase of the model:
- `diariesRef.csv` contains diaries of typical days extracted from the UK Time Use Survey
- `businessRegistry.csv` contains a list of all individual workplaces in GB
- `timeAtHomeIncreaseCTY.csv` contains a reduction in time spent away from home during the pandemic according to Google Mobility reports 
- `lookUp-GB.csv` is a comprehensive lookup table between GB geographies, including name variants used by Google and OSM and local file names for storage within Azure

To understand the methods supporting the creation of these files, refer to the corresponding section inside the [modelling methods](https://alan-turing-institute.github.io/uatk-spc/modelling_methods.html).

### Enriching SPENSER

Instructions to run this step can be found under [Step 2: Add to SPENSER](https://github.com/alan-turing-institute/uatk-spc/tree/main/scripts/data_prep).
Lines number quoted in the following refer to this [script](https://github.com/alan-turing-institute/uatk-spc/blob/main/scripts/data_prep/SPC_pipelineLAD.R).

Once merged into one dataset according to the matching key (l. 13-49), the SPENSER data is enriched with the outputs of the previous step.
An individual among those sharing the same 5-year age group (see code for details of age groups for under 18) and sex is drawn from the participants of the Health Survey (l. 56-72).
This adds the `id_HS`, `HEALTH_diabetes`, `HEALTH_bloodpressure`, `HEALTH_cvd`, `HEALTH_NMedecines`, `HEALTH_selfAssessed` and `HEALTH_lifeSat` [fields](https://alan-turing-institute.github.io/uatk-spc/data_sources.html#pop_.csv.gz).
This join is not spatially differentiated and other matching criteria (ethnicity and nssec8) were retained due to a lack of representativity inside the survey.
The BMI field is then added l. 74-89.
Each individual that is not a head of household is assigned an nssec8 category (l. 96-108).
This is done according to nssec8 category distributions among the general population by sex and age groups according to ONS data ([DC6114EW](https://www.nomisweb.co.uk/census/2011/dc6114ew) and [DC6206SC](https://www.nrscotland.gov.uk/news/2014/census-2011-release-3i) datasets).
An individual among those sharing the same 5-year age group (see code for details of age groups for under 18), sex and nssec8 category is drawn from the participants of the UK Time Use Survey (l. 111-125).
This adds the `id_TUS_hh`, `id_TUS_p`, `pwkstat`, `soc2010`, `sic1d2007`, `sic2d2007`, `netPayWeekly` and `workedHoursWeekly` [fields](https://alan-turing-institute.github.io/uatk-spc/data_sources.html#pop_.csv.gz).
Note that the `netPayWeekly` and `workedHoursWeekly` fields have a low response rate among participants of the survey.
For that reason, we have added a much more detailed modelling of income, see [below](https://alan-turing-institute.github.io/uatk-spc/modelling_methods.html#income-data), that includes spatial differences at region level (l. 130-140).
Coordinates are finally added l. 152-156.

### Azure upload

Tbc.


## Phase 2: Running SPC for a specific study area

This part is corresponding to the scripts written in Rust. Instructions can be found [here](https://alan-turing-institute.github.io/uatk-spc/custom_areas.html). 